<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student — Attendance</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <header class="card">
      <h1>Student View</h1>
      <div class="muted">Select course & your roll to view attendance (auto updates).</div>
    </header>

    <div class="card">
      <label>Course</label>
      <select id="student-course"><option value="">-- select course --</option></select>
      <label style="margin-top:8px">Your Roll</label>
      <select id="student-roll"><option value="">-- select roll --</option></select>
      <div style="margin-top:8px">
        <button id="student-refresh" class="big ghost">Refresh</button>
      </div>
    </div>

    <div id="student-report-wrap"></div>
  </div>

  <script type="module">
    import { db } from './firebase.js';
    import { collection, getDocs, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    document.addEventListener('DOMContentLoaded', async () => {
      const courseSel = document.getElementById('student-course');
      const rollSel = document.getElementById('student-roll');
      const refreshBtn = document.getElementById('student-refresh');
      const wrap = document.getElementById('student-report-wrap');
      let attendanceUnsub = null;
      async function loadCourses(){
        courseSel.innerHTML = '<option value="">-- select course --</option>';
        const snap = await getDocs(collection(db,'courses'));
        snap.forEach(d => {
          const c = d.data(); const opt = document.createElement('option'); opt.value = d.id; opt.textContent = `${c.code} — ${c.name}`; courseSel.appendChild(opt);
        });
      }
      async function loadRolls(courseId){
        rollSel.innerHTML = '<option value="">-- select roll --</option>';
        if(!courseId) return;
        const sSnap = await getDocs(collection(db,'courses',courseId,'students'));
        sSnap.forEach(s=>{ const d=s.data(); const o=document.createElement('option'); o.value=d.roll; o.textContent = `${d.roll} — ${d.name}`; rollSel.appendChild(o); });
      }
      function showReport(courseId, roll){
        wrap.innerHTML = '';
        if(!courseId || !roll) { wrap.innerHTML = '<div class="card muted">Select course & roll</div>'; return; }
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `<h3>Loading...</h3>`;
        wrap.appendChild(card);
        // compute using onSnapshot of attendance collection for real-time updates
        if(attendanceUnsub) attendanceUnsub();
        attendanceUnsub = onSnapshot(collection(db,'courses',courseId,'attendance'), snap => {
          const dates = []; const records = {};
          snap.forEach(d => { dates.push(d.id); records[d.id] = d.data().present || {}; });
          const total = dates.length;
          let present = 0;
          dates.forEach(d => { if(records[d] && records[d][roll]) present++; });
          const percent = total ? Math.round((present/total)*100) : 0;
          const courseText = courseSel.options[courseSel.selectedIndex]?.text || 'Course';
          card.innerHTML = `<h3>${escapeHtml(courseText)}</h3>
            <div class="muted small">Roll: ${escapeHtml(roll)}</div>
            <div style="margin-top:8px">Attended: <strong>${present}</strong> / <strong>${total}</strong></div>
            <div style="margin-top:8px">Percentage: <strong class="${percent>=75 ? 'ok':'danger'}">${percent}%</strong></div>
            <div style="margin-top:8px" class="pbar"><i style="width:${percent}%"></i></div>`;
        }, err => { card.innerHTML = '<div class="muted">Error loading attendance</div>'; console.error(err); });
      }

      courseSel.addEventListener('change', async ()=>{ await loadRolls(courseSel.value); showReport('', ''); });
      rollSel.addEventListener('change', ()=> showReport(courseSel.value, rollSel.value));
      refreshBtn.addEventListener('click', ()=> showReport(courseSel.value, rollSel.value));
      await loadCourses();
      // ensure initial message
      wrap.innerHTML = '<div class="card muted">Select course & roll to view attendance</div>';
    });
  </script>
</body>
</html>
